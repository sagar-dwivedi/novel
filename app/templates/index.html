{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Add New Novel Section -->
    <section class="bg-white rounded-lg shadow-sm border border-stone-200 p-6">
        <h2 class="text-xl font-semibold text-stone-800 mb-4">Add New Novel</h2>
        <form id="scrapeForm" onsubmit="scrapeMetadata(event)" class="space-y-4">
            <div>
                <input 
                    type="url" 
                    name="url" 
                    placeholder="Enter novel URL (e.g., https://libread.com/novel/...)" 
                    required
                    class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-400 focus:border-transparent transition-shadow"
                >
            </div>
            <button 
                type="submit"
                class="w-full sm:w-auto px-6 py-3 bg-stone-800 text-white font-medium rounded-lg hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-400 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Scrape Metadata
            </button>
        </form>
    </section>

    <!-- Your Novels Section -->
    <section>
        <h2 class="text-xl font-semibold text-stone-800 mb-4">Your Novels</h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {% for novel in novels %}
            <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5 hover:shadow-md transition-shadow">
                <h3 class="text-lg font-semibold mb-2">
                    <a href="/novel/{{ novel.slug }}" class="text-stone-800 hover:text-stone-600 transition-colors">
                        {{ novel.title }}
                    </a>
                </h3>
                <p class="text-stone-600 text-sm mb-1">By: {{ novel.author }}</p>
                <p class="text-stone-600 text-sm mb-3">Chapters: {{ novel.chapters|length }}</p>
                <small class="text-stone-500 text-xs">Added: {{ novel.created_at.strftime('%Y-%m-%d') }}</small>
            </div>
            {% else %}
            <div class="col-span-full bg-stone-100 rounded-lg p-8 text-center">
                <p class="text-stone-600">No novels added yet. Add a novel using the form above.</p>
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<script>
async function scrapeMetadata(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const button = event.target.querySelector('button');
    const originalText = button.textContent;
    
    button.textContent = 'Scraping...';
    button.disabled = true;
    
    try {
        const response = await fetch('/scrape-metadata', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            // Use View Transition API if available
            if (document.startViewTransition) {
                document.startViewTransition(() => {
                    window.location.href = `/novel/${result.slug}`;
                });
            } else {
                window.location.href = `/novel/${result.slug}`;
            }
        } else {
            alert('Error: ' + result.detail);
        }
    } catch (error) {
        alert('Error scraping metadata: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}
</script>
{% endblock %}