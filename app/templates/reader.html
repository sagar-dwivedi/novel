{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6 relative" id="reader-container">
    <!-- Scroll Progress Bar -->
    <div id="scrollProgress" class="fixed top-0 left-0 h-1 bg-stone-800 w-0 z-50 transition-all"></div>

    <!-- Reader Header -->
    <header class="text-center space-y-2 pb-6 border-b border-stone-200">
        <h2 class="text-lg font-semibold">
            <a href="/novel/{{ novel.slug }}" class="text-stone-600 hover:text-stone-800 transition-colors">
                {{ novel.title }}
            </a>
        </h2>
        <h3 class="text-2xl font-bold text-stone-900">
            Chapter {{ chapter.chapter_number }}: {{ chapter.title }}
        </h3>
    </header>

    <!-- Top Navigation -->
    <nav aria-label="chapter navigation"
        class="flex flex-wrap items-center justify-between gap-3 bg-white rounded-lg border border-stone-200 p-4 sticky top-0 z-40 backdrop-blur-md bg-white/80">
        {% if prev_chapter %}
        <a href="/read/{{ novel.slug }}/{{ prev_chapter.chapter_number }}"
            class="px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-800 font-medium rounded-lg transition-colors">
            ‚Üê Previous
        </a>
        {% else %}
        <div class="px-4 py-2 bg-stone-50 text-stone-400 font-medium rounded-lg cursor-not-allowed">
            ‚Üê Previous
        </div>
        {% endif %}

        <select aria-label="Jump to chapter" onchange="location = this.value;"
            class="flex-1 min-w-0 max-w-md px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-400 bg-white text-stone-800">
            {% for chap in all_chapters %}
            <option value="/read/{{ novel.slug }}/{{ chap.chapter_number }}" {% if chap.chapter_number ==
                chapter.chapter_number %}selected{% endif %}>
                Chapter {{ chap.chapter_number }}: {{ chap.title }}
            </option>
            {% endfor %}
        </select>

        {% if next_chapter %}
        <a href="/read/{{ novel.slug }}/{{ next_chapter.chapter_number }}"
            class="px-4 py-2 bg-stone-800 hover:bg-stone-700 text-white font-medium rounded-lg transition-colors">
            Next ‚Üí
        </a>
        {% else %}
        <div class="px-4 py-2 bg-stone-200 text-stone-400 font-medium rounded-lg cursor-not-allowed">
            Next ‚Üí
        </div>
        {% endif %}
    </nav>

    <!-- Reader Content -->
    <article class="bg-white rounded-lg border border-stone-200 p-8 sm:p-12 shadow-sm" id="reader-content">
        <div class="prose prose-stone max-w-none">
            {{ chapter.content|linebreaks }}
        </div>
    </article>

    <!-- Bottom Navigation -->
    <nav aria-label="bottom navigation"
        class="flex flex-wrap items-center justify-between gap-3 bg-white rounded-lg border border-stone-200 p-4">
        {% if prev_chapter %}
        <a href="/read/{{ novel.slug }}/{{ prev_chapter.chapter_number }}"
            class="px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-800 font-medium rounded-lg transition-colors">
            ‚Üê Previous
        </a>
        {% else %}
        <div class="px-4 py-2 bg-stone-50 text-stone-400 font-medium rounded-lg cursor-not-allowed">
            ‚Üê Previous
        </div>
        {% endif %}

        <div class="flex gap-3">
            <button id="toggleMode"
                class="px-4 py-2 bg-white hover:bg-stone-50 text-stone-800 font-medium rounded-lg border border-stone-300 transition-colors">
                üåì Reading Mode
            </button>
            <a href="/novel/{{ novel.slug }}"
                class="px-4 py-2 bg-white hover:bg-stone-50 text-stone-800 font-medium rounded-lg border border-stone-300 transition-colors">
                Back to Novel
            </a>
        </div>

        {% if next_chapter %}
        <a href="/read/{{ novel.slug }}/{{ next_chapter.chapter_number }}"
            class="px-4 py-2 bg-stone-800 hover:bg-stone-700 text-white font-medium rounded-lg transition-colors">
            Next ‚Üí
        </a>
        {% else %}
        <div class="px-4 py-2 bg-stone-200 text-stone-400 font-medium rounded-lg cursor-not-allowed">
            Next ‚Üí
        </div>
        {% endif %}
    </nav>
</div>

<style>
    /* Reading experience */
    .prose {
        font-size: 1.125rem;
        line-height: 1.85;
        color: #292524;
        font-weight: 400;
        text-align: justify;
        max-width: 70ch;
        margin: auto;
    }

    .prose p {
        margin-bottom: 1.6em;
    }

    /* Reading mode: dark theme */
    body.dark-mode {
        background-color: #1c1917;
        color: #e7e5e4;
    }

    body.dark-mode .bg-white {
        background-color: #292524 !important;
    }

    body.dark-mode .text-stone-800 {
        color: #fafaf9 !important;
    }

    body.dark-mode .border-stone-200 {
        border-color: #3f3f46 !important;
    }

    body.dark-mode select,
    body.dark-mode a,
    body.dark-mode button {
        background-color: #3f3f46 !important;
        color: #f5f5f4 !important;
    }

    body.dark-mode .prose {
        color: #e7e5e4;
    }

    /* Scroll progress bar animation */
    #scrollProgress {
        transition: width 0.15s linear;
    }

    @media (prefers-reduced-motion: no-preference) {
        a,
        button,
        select {
            transition: all 0.2s ease-in-out;
        }
    }
</style>

<script>
    // Scroll progress
    document.addEventListener('scroll', () => {
        const content = document.getElementById('reader-content');
        const scrollTop = window.scrollY;
        const height = content.offsetHeight - window.innerHeight;
        const progress = Math.min(100, (scrollTop / height) * 100);
        document.getElementById('scrollProgress').style.width = progress + '%';
    });

    // Reading mode toggle
    const toggleBtn = document.getElementById('toggleMode');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedMode = localStorage.getItem('reading-mode');

    if (storedMode === 'dark' || (!storedMode && prefersDark)) {
        document.body.classList.add('dark-mode');
    }

    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('reading-mode',
            document.body.classList.contains('dark-mode') ? 'dark' : 'light'
        );
    });

    // Keyboard shortcuts for navigation
    document.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;

        const prevLink = document.querySelector('a[href*="/read/{{ novel.slug }}/{{ prev_chapter.chapter_number if prev_chapter else "" }}"]');
        const nextLink = document.querySelector('a[href*="/read/{{ novel.slug }}/{{ next_chapter.chapter_number if next_chapter else "" }}"]');

        if ((e.key === 'ArrowLeft' || e.key === 'a') && prevLink) {
            e.preventDefault();
            prevLink.click();
        }
        if ((e.key === 'ArrowRight' || e.key === 'd') && nextLink) {
            e.preventDefault();
            nextLink.click();
        }
    });
</script>
{% endblock %}
